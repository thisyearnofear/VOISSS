name: Deploy VOISSS Backend

on:
  push:
    branches:
      - main
    paths:
      - 'services/voisss-backend/**'
      - '.github/workflows/deploy-voisss-backend.yml'
  workflow_dispatch:

env:
  RELEASES_TO_KEEP: 5

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      artifact-path: ${{ steps.build.outputs.artifact-path }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: services/voisss-backend/package-lock.json

      - name: Install production dependencies
        working-directory: services/voisss-backend
        run: npm ci --omit=dev

      - name: Create release artifact
        id: build
        run: |
          RELEASE_NAME="release-$(date +%Y-%m-%d_%H-%M-%S)-${GITHUB_SHA:0:7}"
          ARTIFACT_DIR="artifacts/${RELEASE_NAME}"
          
          mkdir -p ${ARTIFACT_DIR}
          
          cp -r services/voisss-backend/src/ ${ARTIFACT_DIR}/
          cp -r services/voisss-backend/node_modules/ ${ARTIFACT_DIR}/
          cp services/voisss-backend/package.json services/voisss-backend/package-lock.json services/voisss-backend/ecosystem.config.js ${ARTIFACT_DIR}/
          cp services/voisss-backend/.env.example ${ARTIFACT_DIR}/
          
          cd artifacts
          tar -czf ${RELEASE_NAME}.tar.gz ${RELEASE_NAME}
          
          echo "artifact-path=${RELEASE_NAME}.tar.gz" >> $GITHUB_OUTPUT
          echo "release-name=${RELEASE_NAME}" >> $GITHUB_OUTPUT
          ls -la ${RELEASE_NAME}.tar.gz

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-artifact
          path: artifacts/*.tar.gz
          retention-days: 1

  deploy:
    needs: build
    runs-on: ubuntu-latest
    
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: release-artifact
          path: ./artifacts

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.HETZNER_SSH_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.HETZNER_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to server
        env:
          DEPLOY_PATH: ${{ secrets.VOISSS_DEPLOY_PATH }}
          SERVER_USER: ${{ secrets.HETZNER_USER }}
          SERVER_HOST: ${{ secrets.HETZNER_HOST }}
        run: |
          ARTIFACT=$(ls artifacts/*.tar.gz | head -1)
          RELEASE_NAME=$(basename "$ARTIFACT" .tar.gz)
          
          scp "$ARTIFACT" ${SERVER_USER}@${SERVER_HOST}:/tmp/
          
          ssh ${SERVER_USER}@${SERVER_HOST} << ENDSSH
            set -e
            
            DEPLOY_PATH="${DEPLOY_PATH}"
            RELEASE_NAME="${RELEASE_NAME}"
            RELEASES_TO_KEEP="${{ env.RELEASES_TO_KEEP }}"
            
            echo "=== Deploying ${RELEASE_NAME} ==="
            
            cd /tmp
            tar -xzf ${RELEASE_NAME}.tar.gz
            
            mkdir -p \${DEPLOY_PATH}/releases
            
            mv \${RELEASE_NAME} \${DEPLOY_PATH}/releases/
            
            if [ ! -f "\${DEPLOY_PATH}/.env" ]; then
              if [ -f "\${DEPLOY_PATH}/releases/\${RELEASE_NAME}/.env.example" ]; then
                cp \${DEPLOY_PATH}/releases/\${RELEASE_NAME}/.env.example \${DEPLOY_PATH}/.env
                echo "⚠️  Created .env from example - please configure!"
              fi
            fi
            
            mkdir -p \${DEPLOY_PATH}/logs
            
            cd \${DEPLOY_PATH}/releases/\${RELEASE_NAME}
            ln -sf \${DEPLOY_PATH}/.env .env
            ln -sf \${DEPLOY_PATH}/logs logs
            
            if [ -L "\${DEPLOY_PATH}/current" ]; then
              PREVIOUS_RELEASE=\$(readlink \${DEPLOY_PATH}/current)
              echo "Previous release: \${PREVIOUS_RELEASE}"
            fi
            
            ln -sfn \${DEPLOY_PATH}/releases/\${RELEASE_NAME} \${DEPLOY_PATH}/current_new
            mv -Tf \${DEPLOY_PATH}/current_new \${DEPLOY_PATH}/current
            
            cd \${DEPLOY_PATH}/current
            pm2 reload ecosystem.config.js || pm2 start ecosystem.config.js
            pm2 save
            
            echo ""
            echo "=== Cleaning up old releases ==="
            cd \${DEPLOY_PATH}/releases
            CURRENT_RELEASE=\$(basename \$(readlink \${DEPLOY_PATH}/current))
            
            ls -1t | grep -v "\${CURRENT_RELEASE}" | tail -n +\${RELEASES_TO_KEEP} | while read old_release; do
              echo "Removing old release: \${old_release}"
              rm -rf "\${old_release}"
            done
            
            rm -f /tmp/\${RELEASE_NAME}.tar.gz
            
            echo ""
            echo "✅ Deployment complete!"
            echo "   Release: \${RELEASE_NAME}"
            echo "   Path: \${DEPLOY_PATH}/current"
            echo ""
            df -h \${DEPLOY_PATH}
          ENDSSH

      - name: Verify deployment
        env:
          SERVER_USER: ${{ secrets.HETZNER_USER }}
          SERVER_HOST: ${{ secrets.HETZNER_HOST }}
          DEPLOY_PATH: ${{ secrets.VOISSS_DEPLOY_PATH }}
        run: |
          ssh ${SERVER_USER}@${SERVER_HOST} << 'ENDSSH'
            sleep 5
            
            pm2 status
            
            curl -f http://localhost:5577/health || exit 1
            
            echo ""
            echo "✅ Service is healthy"
          ENDSSH

      - name: Notify on failure
        if: failure()
        run: |
          echo "❌ Deployment failed. Check logs above."
